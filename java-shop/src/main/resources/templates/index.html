<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÂïÜÂüé - AIÂÆ¢ÊúçÁ§∫‰æã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
        }
        
        .header nav a {
            color: white;
            text-decoration: none;
            margin-left: 30px;
            font-size: 16px;
            transition: opacity 0.3s;
        }
        
        .header nav a:hover {
            opacity: 0.8;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .hero {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .hero h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .hero p {
            color: #666;
            line-height: 1.6;
        }
        
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 60px;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .product-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-price {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        
        .product-stock {
            font-size: 14px;
            color: #999;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* ÂÆ¢ÊúçÁ™óÂè£ */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .chat-button:hover {
            transform: scale(1.1);
        }
        
        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .chat-window.active {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            font-size: 18px;
        }
        
        .chat-close {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .chat-message.user {
            flex-direction: row-reverse;
        }
        
        .chat-message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .chat-message.ai .chat-message-content {
            background: white;
            color: #333;
        }
        
        .chat-message.user .chat-message-content {
            background: #667eea;
            color: white;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .chat-send:hover {
            background: #5568d3;
        }
        
        /* Âä†ËΩΩÁä∂ÊÄÅÊ†∑Âºè */
        .chat-message.loading {
            opacity: 0.7;
        }
        
        .chat-message.loading .chat-message-content {
            background: #f0f0f0 !important;
            color: #999 !important;
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Áî®Êà∑Ê∂àÊÅØÂº∫Ë∞ÉÊ†∑Âºè */
        .chat-message.user[data-permanent="true"] .chat-message-content {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üö¥ Êô∫ËÉΩÂïÜÂüé</h1>
            <nav>
                <a href="/">È¶ñÈ°µ</a>
                <a href="/orders">ÊàëÁöÑËÆ¢Âçï</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="hero">
            <h2>Ê¨¢ËøéÊù•Âà∞Êô∫ËÉΩÂïÜÂüé AI ÂÆ¢ÊúçÁ§∫‰æã</h2>
            <p>ËøôÊòØ‰∏Ä‰∏™Â±ïÁ§∫ AI ÂÆ¢ÊúçËÉΩÂäõÁöÑÁ§∫‰æãÈ°πÁõÆ„ÄÇÊîØÊåÅ RAG Áü•ËØÜÊ£ÄÁ¥¢Âíå MCP Â∑•ÂÖ∑Ë∞ÉÁî®„ÄÇÁÇπÂáªÂè≥‰∏ãËßíÁöÑÂÆ¢ÊúçÊåâÈíÆÂºÄÂßãÂØπËØù!</p>
        </div>

        <div class="products">
            <div th:each="product : ${products}" class="product-card" th:onclick="'showProductModal(' + ${product.id} + ')'">
                <div class="product-image">üö¥</div>
                <div class="product-info">
                    <div class="product-name" th:text="${product.name}">ÂïÜÂìÅÂêçÁß∞</div>
                    <div class="product-desc" th:text="${product.description}">ÂïÜÂìÅÊèèËø∞</div>
                    <div class="product-footer">
                        <div class="product-price">¬•<span th:text="${product.price}">0</span></div>
                        <div class="product-stock">Â∫ìÂ≠ò: <span th:text="${product.stock}">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÆ¢ÊúçÊåâÈíÆ -->
    <div class="chat-button" onclick="toggleChat()">üí¨</div>

    <!-- ÂÆ¢ÊúçÁ™óÂè£ -->
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>ü§ñ AI ÂÆ¢Êúç</h3>
            <span class="chat-close" onclick="toggleChat()">√ó</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message ai">
                <div class="chat-message-content">
                    ÊÇ®Â•Ω!ÊàëÊòØÊô∫ËÉΩÂÆ¢ÊúçÂä©Êâã„ÄÇÊàëÂèØ‰ª•Â∏ÆÊÇ®Êü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØ„ÄÅËÆ¢ÂçïÁä∂ÊÄÅ,ÊàñËÄÖËß£Á≠îÂÖ∂‰ªñÈóÆÈ¢ò„ÄÇÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÂêó?
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendMessage()">ÂèëÈÄÅ</button>
        </div>
    </div>

    <!-- ‰∏ãÂçï Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h3>‰∏ãÂçïË¥≠‰π∞</h3>
            <input type="hidden" id="orderProductId">
            <div class="form-group">
                <label>ÂïÜÂìÅÂêçÁß∞</label>
                <input type="text" id="orderProductName" readonly>
            </div>
            <div class="form-group">
                <label>Ë¥≠‰π∞Êï∞Èáè</label>
                <input type="number" id="orderQuantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label>ÂßìÂêç</label>
                <input type="text" id="orderCustomerName" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç">
            </div>
            <div class="form-group">
                <label>ÁîµËØù</label>
                <input type="text" id="orderCustomerPhone" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁîµËØù">
            </div>
            <div class="form-group">
                <label>Êî∂Ë¥ßÂú∞ÂùÄ</label>
                <textarea id="orderShippingAddress" rows="3" placeholder="ËØ∑ËæìÂÖ•Êî∂Ë¥ßÂú∞ÂùÄ"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeOrderModal()">ÂèñÊ∂à</button>
                <button class="btn" onclick="submitOrder()">Á°ÆËÆ§‰∏ãÂçï</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const products = /*[[${products}]]*/ [];
        /*]]>*/

        function toggleChat() {
            document.getElementById('chatWindow').classList.toggle('active');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Â≠òÂÇ®ËÅäÂ§©ÂéÜÂè≤ÔºàÊúÄÂ§ö‰øùÁïôNËΩÆÂØπËØùÔºåÂç≥2NÊù°Ê∂àÊÅØÔºâ
        let chatHistory = [];
        let MAX_HISTORY = 20; // ÈªòËÆ§ÂÄºÔºå‰ºö‰ªéÂêéÁ´ØÂä†ËΩΩ
        
        // ‰ªéÂêéÁ´ØÂä†ËΩΩÈÖçÁΩÆ
        async function loadConfig() {
            try {
                const response = await fetch('/api/chat/config');
                const config = await response.json();
                MAX_HISTORY = config.maxHistoryRounds;
                console.log('üìä ËÅäÂ§©ÈÖçÁΩÆÂ∑≤Âä†ËΩΩ: ÊúÄÂ§ßËÆ∞ÂøÜËΩÆÊï∞ =', MAX_HISTORY);
            } catch (error) {
                console.warn('‚ö†Ô∏è Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº:', MAX_HISTORY, error);
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÈÖçÁΩÆ
        loadConfig();

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            
            // 1. ÂÖàÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            chatHistory.push({ role: 'user', content: message });
            
            // 2. ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØÔºàÂõ∫ÂÆöÊòæÁ§∫Ôºå‰∏ç‰ºöË¢´Âà†Èô§Ôºâ
            const userMsgId = addMessage(message, 'user');
            console.log('‚úÖ Áî®Êà∑Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞DOM:', userMsgId);
            
            // 3. ÊòæÁ§∫AIÂä†ËΩΩÁä∂ÊÄÅÔºà‰ºöË¢´Âà†Èô§ÊõøÊç¢Ôºâ
            const loadingId = addMessage('Ê≠£Âú®ÊÄùËÄÉ...', 'ai', true);
            console.log('‚è≥ Âä†ËΩΩÊ∂àÊÅØÂ∑≤Ê∑ªÂä†:', loadingId);
            
            try {
                // ÂáÜÂ§áÂéÜÂè≤Ê∂àÊÅØÔºàÊúÄÂ§ö5ËΩÆÔºâ
                const historyToSend = chatHistory.slice(-MAX_HISTORY * 2);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        userId: 'web-user',
                        sessionId: getSessionId(),
                        history: historyToSend
                    })
                });
                
                const data = await response.json();
                
                // 4. ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                    console.log('üóëÔ∏è Âä†ËΩΩÊ∂àÊÅØÂ∑≤ÁßªÈô§');
                }
                
                // 5. ÊòæÁ§∫AIÂõûÂ§ç
                const aiMsgId = addMessage(data.reply, 'ai');
                console.log('‚úÖ AIÂõûÂ§çÂ∑≤Ê∑ªÂä†:', aiMsgId);
                
                // 6. Ê∑ªÂä†AIÂõûÂ§çÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                chatHistory.push({ role: 'assistant', content: data.reply });
                
                // 7. ‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩïÂú®ÊúÄÂ§ßÈôêÂà∂ÂÜÖ
                if (chatHistory.length > MAX_HISTORY * 2) {
                    chatHistory = chatHistory.slice(-MAX_HISTORY * 2);
                }
                
                console.log('üìä ÂΩìÂâçËÅäÂ§©ÂéÜÂè≤ÈïøÂ∫¶:', chatHistory.length);
                
            } catch (error) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                addMessage('Êä±Ê≠â,ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®,ËØ∑Á®çÂêéÂÜçËØï„ÄÇ', 'ai');
                console.error('‚ùå Chat error:', error);
            }
        }

        function addMessage(content, type, isLoading = false) {
            const messagesDiv = document.getElementById('chatMessages');
            // ‰ΩøÁî®Êõ¥Á≤æÁ°ÆÁöÑÊó∂Èó¥Êà≥ÂíåÈöèÊú∫Êï∞ÔºåÁ°Æ‰øùÂîØ‰∏ÄÊÄß
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            if (isLoading) {
                messageDiv.classList.add('loading');
                messageDiv.setAttribute('data-removable', 'true'); // Ê†áËÆ∞ÂèØÂà†Èô§
            } else if (type === 'user') {
                messageDiv.setAttribute('data-permanent', 'true'); // Ê†áËÆ∞Áî®Êà∑Ê∂àÊÅØ‰∏∫Ê∞∏‰πÖ
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // Âπ≥ÊªëÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 10);
            
            console.log(`üìù Ê∂àÊÅØÂ∑≤Ê∑ªÂä† [${type}]: ${messageId} - "${content.substring(0, 30)}..."`);
            
            return messageId;
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('chatSessionId');
            if (!sessionId) {
                sessionId = 'session-' + Date.now();
                sessionStorage.setItem('chatSessionId', sessionId);
            }
            return sessionId;
        }

        function showProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('orderProductId').value = product.id;
            document.getElementById('orderProductName').value = product.name;
            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        async function submitOrder() {
            const productId = document.getElementById('orderProductId').value;
            const quantity = document.getElementById('orderQuantity').value;
            const customerName = document.getElementById('orderCustomerName').value;
            const customerPhone = document.getElementById('orderCustomerPhone').value;
            const shippingAddress = document.getElementById('orderShippingAddress').value;
            
            if (!customerName || !customerPhone || !shippingAddress) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑËÆ¢Âçï‰ø°ÊÅØ');
                return;
            }
            
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: parseInt(productId),
                        quantity: parseInt(quantity),
                        customerName,
                        customerPhone,
                        shippingAddress
                    })
                });
                
                if (response.ok) {
                    const order = await response.json();
                    alert('‰∏ãÂçïÊàêÂäü!ËÆ¢ÂçïÂè∑: ' + order.orderNumber);
                    closeOrderModal();
                    
                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('orderCustomerName').value = '';
                    document.getElementById('orderCustomerPhone').value = '';
                    document.getElementById('orderShippingAddress').value = '';
                    document.getElementById('orderQuantity').value = '1';
                } else {
                    const error = await response.json();
                    alert('‰∏ãÂçïÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                alert('‰∏ãÂçïÂ§±Ë¥•,ËØ∑Á®çÂêéÂÜçËØï');
                console.error('Order error:', error);
            }
        }

        // ÁÇπÂáªmodalÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeOrderModal();
            }
        }
    </script>
</body>
</html>
