<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å•†åŸ - AIå®¢æœç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
        }
        
        .header nav a {
            color: white;
            text-decoration: none;
            margin-left: 30px;
            font-size: 16px;
            transition: opacity 0.3s;
        }
        
        .header nav a:hover {
            opacity: 0.8;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .hero {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .hero h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .hero p {
            color: #666;
            line-height: 1.6;
        }
        
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 60px;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .product-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-price {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        
        .product-stock {
            font-size: 14px;
            color: #999;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* å®¢æœçª—å£ */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .chat-button:hover {
            transform: scale(1.1);
        }
        
        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .chat-window.active {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            font-size: 18px;
        }
        
        .chat-close {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .chat-message.user {
            flex-direction: row-reverse;
        }
        
        .chat-message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .chat-message.ai .chat-message-content {
            background: white;
            color: #333;
        }
        
        .chat-message.user .chat-message-content {
            background: #667eea;
            color: white;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .chat-send:hover {
            background: #5568d3;
        }
        
        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .chat-message.loading {
            opacity: 0.7;
        }
        
        .chat-message.loading .chat-message-content {
            background: #f0f0f0 !important;
            color: #999 !important;
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ç”¨æˆ·æ¶ˆæ¯å¼ºè°ƒæ ·å¼ */
        .chat-message.user[data-permanent="true"] .chat-message-content {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸš´ æ™ºèƒ½å•†åŸ</h1>
            <nav>
                <a href="/">é¦–é¡µ</a>
                <a href="/orders">æˆ‘çš„è®¢å•</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="hero">
            <h2>æ¬¢è¿æ¥åˆ°æ™ºèƒ½å•†åŸ AI å®¢æœç¤ºä¾‹</h2>
            <p>è¿™æ˜¯ä¸€ä¸ªå±•ç¤º AI å®¢æœèƒ½åŠ›çš„ç¤ºä¾‹é¡¹ç›®ã€‚æ”¯æŒ RAG çŸ¥è¯†æ£€ç´¢å’Œ MCP å·¥å…·è°ƒç”¨ã€‚ç‚¹å‡»å³ä¸‹è§’çš„å®¢æœæŒ‰é’®å¼€å§‹å¯¹è¯!</p>
        </div>

        <div class="products">
            <div th:each="product : ${products}" class="product-card" th:onclick="'showProductModal(' + ${product.id} + ')'">
                <div class="product-image">ğŸš´</div>
                <div class="product-info">
                    <div class="product-name" th:text="${product.name}">å•†å“åç§°</div>
                    <div class="product-desc" th:text="${product.description}">å•†å“æè¿°</div>
                    <div class="product-footer">
                        <div class="product-price">Â¥<span th:text="${product.price}">0</span></div>
                        <div class="product-stock">åº“å­˜: <span th:text="${product.stock}">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å®¢æœæŒ‰é’® -->
    <div class="chat-button" onclick="toggleChat()">ğŸ’¬</div>

    <!-- å®¢æœçª—å£ -->
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>ğŸ¤– AI å®¢æœ</h3>
            <span class="chat-close" onclick="toggleChat()">Ã—</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message ai">
                <div class="chat-message-content">
                    æ‚¨å¥½!æˆ‘æ˜¯æ™ºèƒ½å®¢æœåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢å•†å“ä¿¡æ¯ã€è®¢å•çŠ¶æ€,æˆ–è€…è§£ç­”å…¶ä»–é—®é¢˜ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—?
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <!-- ä¸‹å• Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h3>ä¸‹å•è´­ä¹°</h3>
            <input type="hidden" id="orderProductId">
            <div class="form-group">
                <label>å•†å“åç§°</label>
                <input type="text" id="orderProductName" readonly>
            </div>
            <div class="form-group">
                <label>è´­ä¹°æ•°é‡</label>
                <input type="number" id="orderQuantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="orderCustomerName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            </div>
            <div class="form-group">
                <label>ç”µè¯</label>
                <input type="text" id="orderCustomerPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”µè¯">
            </div>
            <div class="form-group">
                <label>æ”¶è´§åœ°å€</label>
                <textarea id="orderShippingAddress" rows="3" placeholder="è¯·è¾“å…¥æ”¶è´§åœ°å€"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeOrderModal()">å–æ¶ˆ</button>
                <button class="btn" onclick="submitOrder()">ç¡®è®¤ä¸‹å•</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const products = /*[[${products}]]*/ [];
        /*]]>*/

        function toggleChat() {
            document.getElementById('chatWindow').classList.toggle('active');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // å­˜å‚¨èŠå¤©å†å²ï¼ˆæœ€å¤šä¿ç•™Nè½®å¯¹è¯ï¼Œå³2Næ¡æ¶ˆæ¯ï¼‰
        let chatHistory = [];
        let MAX_HISTORY = 20; // é»˜è®¤å€¼ï¼Œä¼šä»åç«¯åŠ è½½
        
        // ä»åç«¯åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/chat/config');
                const config = await response.json();
                MAX_HISTORY = config.maxHistoryRounds;
                console.log('ğŸ“Š èŠå¤©é…ç½®å·²åŠ è½½: æœ€å¤§è®°å¿†è½®æ•° =', MAX_HISTORY);
            } catch (error) {
                console.warn('âš ï¸ åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', MAX_HISTORY, error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®
        loadConfig();

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // 1. å…ˆæ·»åŠ åˆ°å†å²è®°å½•
            chatHistory.push({ role: 'user', content: message });
            
            // 2. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆå›ºå®šæ˜¾ç¤ºï¼Œä¸ä¼šè¢«åˆ é™¤ï¼‰
            const userMsgId = addMessage(message, 'user');
            console.log('âœ… ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ åˆ°DOM:', userMsgId);
            
            // 3. æ˜¾ç¤ºAIåŠ è½½çŠ¶æ€ï¼ˆä¼šè¢«åˆ é™¤æ›¿æ¢ï¼‰
            const loadingId = addMessage('æ­£åœ¨æ€è€ƒ...', 'ai', true);
            console.log('â³ åŠ è½½æ¶ˆæ¯å·²æ·»åŠ :', loadingId);
            
            try {
                // å‡†å¤‡å†å²æ¶ˆæ¯ï¼ˆæœ€å¤š5è½®ï¼‰
                const historyToSend = chatHistory.slice(-MAX_HISTORY * 2);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        userId: 'web-user',
                        sessionId: getSessionId(),
                        history: historyToSend
                    })
                });
                
                const data = await response.json();
                
                // 4. ç§»é™¤åŠ è½½æ¶ˆæ¯
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                    console.log('ğŸ—‘ï¸ åŠ è½½æ¶ˆæ¯å·²ç§»é™¤');
                }
                
                // 5. æ˜¾ç¤ºAIå›å¤
                const aiMsgId = addMessage(data.reply, 'ai');
                console.log('âœ… AIå›å¤å·²æ·»åŠ :', aiMsgId);
                
                // 6. æ·»åŠ AIå›å¤åˆ°å†å²è®°å½•
                chatHistory.push({ role: 'assistant', content: data.reply });
                
                // 7. ä¿æŒå†å²è®°å½•åœ¨æœ€å¤§é™åˆ¶å†…
                if (chatHistory.length > MAX_HISTORY * 2) {
                    chatHistory = chatHistory.slice(-MAX_HISTORY * 2);
                }
                
                console.log('ğŸ“Š å½“å‰èŠå¤©å†å²é•¿åº¦:', chatHistory.length);
                
            } catch (error) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                addMessage('æŠ±æ­‰,æœåŠ¡æš‚æ—¶ä¸å¯ç”¨,è¯·ç¨åå†è¯•ã€‚', 'ai');
                console.error('âŒ Chat error:', error);
            }
        }

        function addMessage(content, type, isLoading = false) {
            const messagesDiv = document.getElementById('chatMessages');
            // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ—¶é—´æˆ³å’Œéšæœºæ•°ï¼Œç¡®ä¿å”¯ä¸€æ€§
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}`;
            if (isLoading) {
                messageDiv.classList.add('loading');
                messageDiv.setAttribute('data-removable', 'true'); // æ ‡è®°å¯åˆ é™¤
            } else if (type === 'user') {
                messageDiv.setAttribute('data-permanent', 'true'); // æ ‡è®°ç”¨æˆ·æ¶ˆæ¯ä¸ºæ°¸ä¹…
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 10);
            
            console.log(`ğŸ“ æ¶ˆæ¯å·²æ·»åŠ  [${type}]: ${messageId} - "${content.substring(0, 30)}..."`);
            
            return messageId;
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('chatSessionId');
            if (!sessionId) {
                sessionId = 'session-' + Date.now();
                sessionStorage.setItem('chatSessionId', sessionId);
            }
            return sessionId;
        }

        function showProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('orderProductId').value = product.id;
            document.getElementById('orderProductName').value = product.name;
            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        async function submitOrder() {
            const productId = document.getElementById('orderProductId').value;
            const quantity = document.getElementById('orderQuantity').value;
            const customerName = document.getElementById('orderCustomerName').value;
            const customerPhone = document.getElementById('orderCustomerPhone').value;
            const shippingAddress = document.getElementById('orderShippingAddress').value;
            
            if (!customerName || !customerPhone || !shippingAddress) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: parseInt(productId),
                        quantity: parseInt(quantity),
                        customerName,
                        customerPhone,
                        shippingAddress
                    })
                });
                
                if (response.ok) {
                    const order = await response.json();
                    alert('ä¸‹å•æˆåŠŸ!è®¢å•å·: ' + order.orderNumber);
                    closeOrderModal();
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('orderCustomerName').value = '';
                    document.getElementById('orderCustomerPhone').value = '';
                    document.getElementById('orderShippingAddress').value = '';
                    document.getElementById('orderQuantity').value = '1';
                } else {
                    const error = await response.json();
                    alert('ä¸‹å•å¤±è´¥: ' + error.error);
                }
            } catch (error) {
                alert('ä¸‹å•å¤±è´¥,è¯·ç¨åå†è¯•');
                console.error('Order error:', error);
            }
        }

        // ç‚¹å‡»modalå¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeOrderModal();
            }
        }
    </script>
</body>
</html>
