# AI 智能商城客服系统

基于 RAG 和 MCP 技术的智能客服系统，支持知识检索、多轮对话和工具调用。

## 技术栈

- **AI 引擎**: Go 1.21 + Gin
- **商城服务**: Java Spring Boot 3.2 + H2 Database
- **MCP 服务**: Python 3.11
- **向量数据库**: Chroma
- **LLM**: 阿里云 DashScope (Qwen-Max)
- **部署**: Docker Compose

## 快速启动

```bash
# 1. 配置环境变量
cp .env.example .env
# 编辑 .env，填入 DASHSCOPE_API_KEY

# 2. 启动所有服务
docker-compose up -d --build

# 3. 初始化知识库（等待 30 秒后执行）
docker-compose exec -T knowledge python /app/init_knowledge_rest.py

# 4. 访问系统
# http://localhost:8080
```

## 项目架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户浏览器                                  │
│                      http://localhost:8080                          │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Java Shop Service (端口: 8080)                     │
│                       Spring Boot 3.2 + H2                          │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────────────┐   │
│  │   商品管理   │  │   订单管理    │  │  ChatController          │   │
│  │  (CRUD API) │  │  (CRUD API)  │  │  - 聊天接口              │   │
│  │             │  │              │  │  - 历史消息转发          │   │
│  └─────────────┘  └──────────────┘  │  - 配置 API              │   │
│                                      └──────────┬───────────────┘   │
│  ┌──────────────────────────────────────────────┘                   │
│  │                H2 Database                                       │
│  │  (文件持久化: /data/shop.mv.db)                                  │
│  └──────────────────────────────────────────────────────────────────│
└───────────────────────────────┬─────────────────────────────────────┘
                                │ HTTP POST /api/chat
                                │ { message, history }
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Go AI Service (端口: 8081)                         │
│                          Gin Framework                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Chat Handler                               │  │
│  │  1. 接收用户消息 + 对话历史 (最多 20 轮)                        │  │
│  │  2. 判断是否需要知识检索                                       │  │
│  │  3. 构建 LLM Prompt (System + Context + History)              │  │
│  │  4. 调用 LLM 生成回复                                          │  │
│  │  5. 解析工具调用并执行                                         │  │
│  └────┬──────────────────┬─────────────────────┬─────────────────┘  │
│       │                  │                     │                    │
│       ▼                  ▼                     ▼                    │
│  ┌─────────┐      ┌────────────┐       ┌──────────────┐           │
│  │   RAG   │      │    LLM     │       │     MCP      │           │
│  │  Engine │      │   Client   │       │    Client    │           │
│  └────┬────┘      └─────┬──────┘       └──────┬───────┘           │
│       │                 │                     │                    │
└───────┼─────────────────┼─────────────────────┼────────────────────┘
        │                 │                     │
        ▼                 ▼                     ▼
┌──────────────┐  ┌──────────────────┐  ┌──────────────────────────┐
│    Chroma    │  │    DashScope     │  │    MCP Server (Python)   │
│  Vector DB   │  │   (阿里云 LLM)    │  │    (端口: STDIO 通信)     │
│ (端口: 8000) │  │                  │  ├──────────────────────────┤
├──────────────┤  │  - qwen-max      │  │  工具列表:                │
│  - products  │  │    (对话生成)     │  │  ✓ search_products       │
│    知识库    │  │                  │  │    (商品搜索)             │
│  - faq       │  │  - embedding-v2  │  │  ✓ get_order             │
│    知识库    │  │    (向量化)       │  │    (订单查询)             │
└──────────────┘  └──────────────────┘  │  ✓ create_order          │
                                        │    (创建订单)             │
                                        └──────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                           数据流示例                                 │
├─────────────────────────────────────────────────────────────────────┤
│  用户: "你们有山地自行车吗？"                                         │
│    ↓                                                                │
│  1. Java Shop 转发 → Go AI Service                                 │
│  2. RAG 检索 Chroma → 找到商品知识                                   │
│  3. LLM 生成回复: "🔍 找到 1 个商品：山地自行车 Pro X1..."           │
│    ↓                                                                │
│  用户: "多少钱？" (携带历史上下文)                                    │
│    ↓                                                                │
│  1. Go AI Service 接收历史记录                                       │
│  2. LLM 理解上下文 (知道是问山地自行车的价格)                         │
│  3. 调用 MCP 工具: search_products("山地自行车")                     │
│  4. 返回: "山地自行车 Pro X1 的价格是 ¥3999.0"                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 目录结构

```
ai-example/
├── go-ai-service/              # Go AI 客服引擎
│   ├── handlers/
│   │   └── chat_handler.go    # 聊天处理 + 历史记忆
│   ├── llm/
│   │   ├── client.go           # DashScope 客户端
│   │   └── tool_calling.go    # 工具调用解析
│   ├── rag/
│   │   └── chroma_client.go   # 向量检索
│   ├── mcp/
│   │   ├── client.go           # MCP STDIO 通信
│   │   └── executor.go         # 工具执行器
│   └── main.go
│
├── java-shop/                  # Java 商城服务
│   ├── controller/
│   │   ├── ChatController.java
│   │   ├── ProductController.java
│   │   └── OrderController.java
│   ├── service/
│   │   └── AiChatService.java
│   ├── model/
│   │   ├── Product.java
│   │   └── Order.java
│   └── resources/
│       ├── application.yml
│       └── templates/
│           └── index.html      # 前端界面
│
├── mcp-server/                 # Python MCP 工具服务器
│   ├── server.py               # MCP 协议实现
│   └── requirements.txt
│
├── knowledge/                  # 知识库初始化
│   ├── init_knowledge_rest.py # 向量化脚本
│   ├── products.txt            # 商品知识
│   └── faq.txt                 # FAQ 文档
│
├── docker-compose.yml          # 服务编排配置
├── .env                        # 环境变量
└── README.md                   # 项目文档
```